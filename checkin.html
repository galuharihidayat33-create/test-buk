<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check-In - Guestbook</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>body{font-family:'Poppins',system-ui, sans-serif}</style>
</head>
<body class="min-h-screen bg-gray-50">
  <div class="container mx-auto p-6">
    <a href="index.html" class="text-sm text-gray-600">← Kembali</a>
    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="md:col-span-2 bg-white rounded-2xl p-6 shadow">
        <h2 class="text-lg font-semibold">Scan QR untuk Check-In</h2>
        <p class="text-sm text-gray-500">Izinkan akses kamera. Untuk hasil terbaik gunakan mode landscape pada HP.</p>
        <div class="mt-4">
          <video id="video" class="w-full rounded-md bg-black" autoplay muted playsinline></video>
          <canvas id="canvas" class="hidden"></canvas>
          <p id="scanMsg" class="mt-2 text-green-600"></p>
        </div>

        <div class="mt-4 flex gap-2">
          <button id="startCam" class="px-4 py-2 rounded bg-indigo-600 text-white">Mulai Kamera</button>
          <button id="stopCam" class="px-4 py-2 rounded border">Stop</button>
        </div>

        <hr class="my-4">
        <h3 class="font-medium">Manual Check-In (kode/ID)</h3>
        <div class="flex gap-2 mt-2">
          <input id="manualCode" class="flex-1 rounded border px-3 py-2" placeholder="Masukkan ID tamu, mis: GUEST-001" />
          <button id="btnManual" class="px-4 py-2 rounded bg-amber-500 text-white">Check-in</button>
        </div>

        <div class="mt-4">
          <h4 class="font-medium">Generate QR Event / Tamu</h4>
          <div id="qrArea" class="mt-2 bg-gray-100 p-3 rounded"></div>
        </div>

      </div>

      <aside class="bg-white rounded-2xl p-6 shadow">
        <h4 class="font-semibold">Operator Quick Add</h4>
        <form id="opForm" class="mt-3 space-y-3">
          <input id="opName" class="w-full rounded border px-3 py-2" placeholder="Nama tamu" required />
          <input id="opContact" class="w-full rounded border px-3 py-2" placeholder="Kontak" />
          <div class="flex gap-2">
            <button class="px-4 py-2 rounded bg-green-600 text-white">Tambah & Check-in</button>
            <button id="genQrForNew" type="button" class="px-4 py-2 rounded border">Generate QR</button>
          </div>
        </form>

        <hr class="my-4">
        <h5 class="font-medium">Daftar Tamu (preview)</h5>
        <div id="guestPreview" class="mt-3 text-sm text-gray-600"></div>
      </aside>
    </div>
  </div>

<script>
// localStorage key
const KEY='wedding_guest_v2';
let guests = JSON.parse(localStorage.getItem(KEY)||'[]');
if(guests.length===0){
  guests = [ {id:'GUEST-001',name:'Siti Nurhaliza',contact:'0812xxxx',checkedIn:false,time:null} ];
  localStorage.setItem(KEY, JSON.stringify(guests));
}

function renderPreview(){
  const el = document.getElementById('guestPreview'); el.innerHTML='';
  guests.slice(0,8).forEach(g=>{
    const div = document.createElement('div'); div.textContent = `${g.id} — ${g.name} — ${g.checkedIn? 'Hadir':'Belum'}`; el.appendChild(div);
  });
}
renderPreview();

// Manual check-in
document.getElementById('btnManual').addEventListener('click', ()=>{
  const code = document.getElementById('manualCode').value.trim(); if(!code) return alert('Masukkan kode');
  const g = guests.find(x=>x.id===code);
  if(g){ g.checkedIn=true; g.time=new Date().toLocaleString(); localStorage.setItem(KEY, JSON.stringify(guests)); renderPreview(); alert('Check-in: '+g.name); }
  else alert('Tamu tidak ditemukan');
});

// Operator add
document.getElementById('opForm').addEventListener('submit', e=>{ e.preventDefault();
  const name = document.getElementById('opName').value.trim(); const contact = document.getElementById('opContact').value.trim();
  if(!name) return alert('Nama wajib');
  const id = 'GUEST-'+String(Math.floor(Math.random()*90000)+10000);
  const newG = {id,name,contact,checkedIn:true,time:new Date().toLocaleString()}; guests.unshift(newG); localStorage.setItem(KEY, JSON.stringify(guests)); renderPreview(); document.getElementById('opForm').reset();
});

// Generate QR for new (shows canvas)
document.getElementById('genQrForNew').addEventListener('click', ()=>{
  const name = document.getElementById('opName').value.trim(); if(!name) return alert('Masukkan nama dulu');
  const id = 'GUEST-'+String(Math.floor(Math.random()*90000)+10000);
  const payload = id;
  const container = document.getElementById('qrArea'); container.innerHTML='';
  const c = document.createElement('canvas'); container.appendChild(c);
  QRCode.toCanvas(c, payload, {width:200}, function(err){ if(err) container.textContent='Gagal generate QR'; else{
    const p = document.createElement('div'); p.className='text-xs text-gray-600 mt-2'; p.textContent = `ID: ${payload}`; container.appendChild(p);
  }});
});

// QR scanner using jsQR
const video = document.getElementById('video'); const canvas = document.getElementById('canvas'); const ctx = canvas.getContext('2d');
let stream=null; let scanning=false;
async function startCam(){
  try{ stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); video.srcObject = stream; await video.play(); scanning=true; scanLoop(); }
  catch(e){ alert('Gagal akses kamera: '+e.message); }
}
function stopCam(){ scanning=false; if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
document.getElementById('startCam').addEventListener('click', startCam);
document.getElementById('stopCam').addEventListener('click', stopCam);

function scanLoop(){ if(!scanning) return; if(video.readyState===video.HAVE_ENOUGH_DATA){ canvas.width = video.videoWidth; canvas.height = video.videoHeight; ctx.drawImage(video,0,0); const image = ctx.getImageData(0,0,canvas.width, canvas.height); const code = jsQR(image.data, image.width, image.height, {inversionAttempts:'dontInvert'}); if(code){ document.getElementById('scanMsg').textContent = 'Kode: '+code.data; const g = guests.find(x=>x.id===code.data); if(g){ g.checkedIn=true; g.time=new Date().toLocaleString(); localStorage.setItem(KEY, JSON.stringify(guests)); renderPreview(); alert('Check-in: '+g.name); } else alert('Tamu tidak terdaftar: '+code.data); scanning=false; setTimeout(()=>{ scanning=true; scanLoop(); }, 1500); return; } }
  requestAnimationFrame(scanLoop);
}

</script>
</body>
</html>