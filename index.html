<!doctype html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wedding Guestbook ‚Äî Modern</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Outfit:wght@300;400;600;700&display=swap"
    rel="stylesheet">

  <!-- Utilities -->
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #0f172a;
      --muted: #64748b;
      --accent: #7c3aed;
      --bg-soft: #fbfbfe;
      --overlay: rgba(12, 12, 18, 0.32);
    }

    html,
    body {
      height: 100%
    }

    body {
      font-family: 'DM Sans', system-ui, -apple-system, "Segoe UI", Roboto;
      background: var(--bg-soft);
      color: var(--primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
    }

    .glass {
      background: rgba(255, 255, 255, 0.86);
      backdrop-filter: blur(6px);
    }

    .card {
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
    }

    .round-md {
      border-radius: 10px;
    }

    .hero-min {
      min-height: 420px;
    }

    @media(min-width:1024px) {
      .hero-min {
        min-height: 520px
      }
    }

    .btn-accent {
      background: linear-gradient(90deg, var(--accent), #a78bfa);
      color: white;
    }

    .text-accent {
      color: var(--accent);
    }

    .countdown {
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .countdown .item {
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      min-width: 64px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(2, 6, 23, 0.06);
    }

    /* loading */
    

    #splash.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* responsive sidebar hide on mobile using transform */
    #sidebar {
      transition: transform .28s ease;
      transform: translateX(0);
    }

    .sidebar-hidden {
      transform: translateX(-110%);
    }

    /* small utilities */
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    }
  </style>
</head>

<body>

  <!-- Splash / loading -->
  
  <!-- Background hero -->
  <div id="bgHero" class="fixed inset-0 bg-cover bg-center"
    style="z-index:0; background-image: linear-gradient(rgba(255,255,255,0.35), rgba(255,255,255,0.35)), url('');">
  </div>
  <div
    style="position:fixed; inset:0; z-index:1; background:linear-gradient(180deg, transparent, rgba(255,255,255,0.45)); pointer-events:none;">
  </div>

  <!-- Login modal -->
  <div id="loginModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
    <div class="w-full max-w-md p-6 round-md glass card">
      <h2 class="text-2xl font-semibold font-Outfit mb-2">Masuk Dashboard</h2>
      <p class="text-sm text-gray-600 mb-4">Pilih role: <strong>Admin</strong> atau <strong>Operator</strong></p>

      <div id="loginOptions" class="space-y-3">
        <div>
          <label class="text-sm text-gray-700">Password Admin</label>
          <input id="adminPass" type="password" placeholder="Masukkan password admin"
            class="w-full mt-2 px-3 py-2 rounded-md border" />
        </div>

        <div class="flex gap-3">
          <button id="btnLoginAdmin" class="flex-1 py-2 rounded-md btn-accent">Masuk sebagai Admin</button>
          <button id="openOpName" class="flex-1 py-2 rounded-md border">Masuk sebagai Operator</button>
        </div>
        <p class="text-xs text-gray-400">Admin default: <code>admin / 1234</code>. Operator masuk cukup dengan
          memasukkan nama.</p>
      </div>

      <div id="opNameArea" class="hidden space-y-3">
        <label class="text-sm text-gray-700">Nama Operator</label>
        <input id="opNameInput" type="text" placeholder="Contoh: Rina"
          class="w-full mt-2 px-3 py-2 rounded-md border" />
        <div class="flex gap-3">
          <button id="btnLoginOp" class="flex-1 py-2 rounded-md bg-emerald-600 text-white">Masuk</button>
          <button id="btnCancelOp" class="flex-1 py-2 rounded-md border">Batal</button>
        </div>
      </div>
    </div>
  </div>

  <!-- App container -->
  <div id="app" class="relative z-20 hidden min-h-screen">

    <!-- Topbar -->
    <div class="sticky top-4 z-30 px-4">
      <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <button id="btnToggleNav" class="p-2 rounded-md border bg-white/90 card" title="Toggle menu">‚ò∞</button>
          <div class="text-lg font-semibold font-Outfit">Wedding Guestbook</div>
        </div>
        <div class="flex items-center gap-3">
          <div id="headerUser" class="text-sm text-gray-700"></div>
          <button id="btnLogout" class="px-3 py-2 rounded-md border bg-white/90">Logout</button>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto lg:flex gap-6 p-4 lg:p-6">

      <!-- Sidebar / Nav -->
      <aside id="sidebar" class="w-full lg:w-72 card glass p-4 round-md" style="z-index:12;">
        <div class="mb-4">
          <div class="text-xs text-gray-500">Event</div>
          <div id="sidebarEventName" class="font-Outfit text-xl">Wedding Guestbook</div>
          <div id="currentBookName" class="text-sm text-gray-500 mt-1">Default</div>
        </div>

        <nav class="space-y-2">
          <button data-section="home" class="navBtn w-full text-left px-4 py-2 rounded-md hover:bg-gray-50">üè†
            Home</button>
          <div class="text-xs text-gray-400 px-4 mt-2">Check-in</div>
          <button data-section="checkin" class="navBtn w-full text-left px-4 py-2 rounded-md hover:bg-gray-50">üéüÔ∏è
            Check-In</button>
          <button data-section="popup" class="navBtn w-full text-left px-4 py-2 rounded-md hover:bg-gray-50">üíå Popup
            Ucapan</button>
          <button data-section="guestbook" class="navBtn w-full text-left px-4 py-2 rounded-md hover:bg-gray-50">‚úçÔ∏è Buku
            Tamu</button>
          <button data-section="database" class="navBtn w-full text-left px-4 py-2 rounded-md hover:bg-gray-50">üìã
            Database</button>
          <button data-section="monitor" class="navBtn w-full text-left px-4 py-2 rounded-md hover:bg-gray-50">üìä
            Monitoring</button>
          <button data-section="settings" class="navBtn w-full text-left px-4 py-2 rounded-md hover:bg-gray-50">‚öôÔ∏è
            Pengaturan</button>
          <button data-section="about" class="navBtn w-full text-left px-4 py-2 rounded-md hover:bg-gray-50">‚ÑπÔ∏è
            About</button>
        </nav>

        <div class="mt-4 text-xs text-gray-500">
          <div>Role: <span id="displayRole" class="font-medium">Operator</span></div>
          <div id="operatorNameDisplay" class="mt-2"></div>
        </div>
      </aside>

      <!-- Main -->
      <main class="flex-1">

        <!-- HOME -->
        <section data-section-id="home" class="section">
          <div class="relative round-md overflow-hidden hero-min card">
            <div id="heroOverlay" class="absolute inset-0" style="background:var(--overlay)"></div>
            <div class="relative z-10 p-8 text-center">
              <h1 id="homeNames" class="text-3xl md:text-5xl font-Outfit font-semibold">Nama A & Nama B</h1>
              <p id="homeSambutan" class="text-sm text-gray-700 max-w-2xl mx-auto mt-3">Terima kasih atas kehadiran ‚Äî
                silakan check-in atau tinggalkan ucapan.</p>

              <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4">
                <div class="bg-white p-4 round-md card min-w-[130px] text-center">
                  <div class="text-xs text-gray-500">Total Tamu</div>
                  <div id="homeTotal" class="text-2xl font-semibold">0</div>
                </div>
                <div class="bg-white p-4 round-md card min-w-[130px] text-center">
                  <div class="text-xs text-gray-500">Hadir</div>
                  <div id="homePresent" class="text-2xl font-semibold">0</div>
                </div>
                <div class="bg-white p-4 round-md card min-w-[130px] text-center">
                  <div class="text-xs text-gray-500">Ucapan</div>
                  <div id="homeMsgs" class="text-2xl font-semibold">0</div>
                </div>
              </div>

              <div class="mt-8">
                <div id="countdownWrap" class="countdown"></div>
              </div>

              <div class="mt-8 max-w-3xl mx-auto text-left">
                <h4 class="font-medium">Ucapan Terbaru</h4>
                <div id="homeLatestMsgs" class="mt-3 space-y-2 max-h-40 overflow-auto bg-white p-3 round-md"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- CHECK-IN -->
        <section data-section-id="checkin" class="section hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-white p-6 round-md card">
              <div class="flex items-start justify-between">
                <div>
                  <h3 class="font-semibold text-lg">Scanner QR (Kamera)</h3>
                  <p class="text-sm text-gray-500">Tekan <strong>Jalankan</strong> untuk mengaktifkan kamera.</p>
                </div>
                <div class="text-sm text-gray-500">Mode: Kamera / Manual</div>
              </div>

              <div class="mt-4">
                <video id="scanVideo" class="w-full rounded-md bg-black" autoplay muted playsinline></video>
                <canvas id="scanCanvas" class="hidden"></canvas>
                <p id="scanStatus" class="mt-2 text-green-600"></p>
                <div class="mt-3 flex gap-2">
                  <button id="startScan" class="px-4 py-2 rounded-md btn-accent">Jalankan</button>
                  <button id="stopScan" class="px-4 py-2 rounded-md border">Stop</button>
                </div>
              </div>

              <hr class="my-4">

              <h4 class="font-medium">Form Tamu (Isi oleh tamu saat datang)</h4>
              <form id="guestFillForm" class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-2">
                <input id="guestNameFill" class="rounded-md border px-3 py-2 md:col-span-2" placeholder="Nama tamu" />
                <input id="guestCountFill" type="number" min="1" value="1" class="rounded-md border px-3 py-2"
                  placeholder="Jumlah" />
                <input id="guestContactFill" class="rounded-md border px-3 py-2 md:col-span-2"
                  placeholder="Kontak (opsional)" />
                <input id="guestUcapanFill" class="rounded-md border px-3 py-2 md:col-span-3"
                  placeholder="Ucapan singkat (opsional)" />
                <button id="btnGuestSubmit" class="px-4 py-2 rounded-md bg-emerald-600 text-white md:col-span-1">Submit
                  & Generate QR</button>
              </form>

              <div class="mt-4" id="guestQrPreview"></div>

              <hr class="my-4">
              <h4 class="font-medium">Daftar Check-in Terakhir</h4>
              <div id="checkinRecent" class="mt-3 space-y-2 max-h-60 overflow-auto"></div>
            </div>

            <aside class="bg-white p-6 round-md card">
              <h4 class="font-semibold">Info</h4>
              <p class="text-sm text-gray-600 mt-2">Pengunjung dapat mengisi form. Setelah submit akan menghasilkan ID &
                QR yang dapat discan untuk verifikasi ulang.</p>
            </aside>
          </div>
        </section>

        <!-- POPUP -->
        <section data-section-id="popup" class="section hidden">
          <div class="bg-white p-6 round-md card">
            <h3 class="font-semibold">Popup Ucapan (Fullscreen)</h3>
            <p class="text-sm text-gray-500">Tampilkan ucapan terbaru ke layar besar (monitor tamu).</p>
            <div class="mt-4 flex gap-2">
              <button id="showPopupBtn" class="px-4 py-2 rounded-md bg-pink-600 text-white">Tampilkan Popup</button>
              <button id="hidePopupBtn" class="px-4 py-2 rounded-md border">Sembunyikan Popup</button>
            </div>
            <div class="mt-4 text-sm text-gray-600">Mode popup mengambil 5 ucapan terbaru.</div>
          </div>
        </section>

        <!-- GUESTBOOK -->
        <section data-section-id="guestbook" class="section hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <main class="lg:col-span-2 bg-white p-6 round-md card">
              <h3 class="font-semibold">Daftar Semua Ucapan (Publik)</h3>
              <div id="msgList" class="mt-3 space-y-3 max-h-96 overflow-auto"></div>
            </main>

            <aside class="bg-white p-6 round-md card">
              <h4 class="font-semibold">Petunjuk</h4>
              <p class="text-sm text-gray-600 mt-2">Halaman ini hanya menampilkan ucapan yang sudah dikirim melalui form
                Check-In.</p>
            </aside>
          </div>
        </section>

        <!-- DATABASE -->
        <section data-section-id="database" class="section hidden">
          <div class="bg-white p-4 round-md card">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Database Tamu</h3>
              <div class="flex gap-2">
                <input id="searchInput" class="rounded-md border px-3 py-2" placeholder="Cari nama atau ID" />
                <button id="exportCsvBtn" class="px-3 py-2 rounded-md border">Export CSV</button>
              </div>
            </div>

            <div class="overflow-x-auto mt-4">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-gray-600">
                    <th class="px-3 py-2">ID</th>
                    <th class="px-3 py-2">Nama</th>
                    <th class="px-3 py-2">Kontak</th>
                    <th class="px-3 py-2">Jumlah</th>
                    <th class="px-3 py-2">Tanggal</th>
                    <th class="px-3 py-2">Waktu</th>
                    <th class="px-3 py-2">Status</th>
                    <th class="px-3 py-2">Ucapan</th>
                    <th class="px-3 py-2">Aksi</th>
                  </tr>
                </thead>
                <tbody id="dbTbody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- MONITOR -->
        <section data-section-id="monitor" class="section hidden">
          <div class="bg-white p-6 round-md card">
            <h3 class="font-semibold">Monitoring (Realtime)</h3>
            <p class="text-sm text-gray-500">Grafik update otomatis setiap 5 detik saat ada data baru.</p>
            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="p-4 bg-white round-md card">
                <h4 class="font-medium">Jumlah Tamu Hadir per Jam</h4>
                <canvas id="chartGuests" height="180"></canvas>
              </div>
              <div class="p-4 bg-white round-md card">
                <h4 class="font-medium">Jumlah Ucapan per Jam</h4>
                <canvas id="chartMsgs" height="180"></canvas>
              </div>
            </div>
          </div>
        </section>

        <!-- SETTINGS -->
        <section data-section-id="settings" class="section hidden">
          <div class="bg-white p-6 round-md card">
            <h3 class="font-semibold">Pengaturan</h3>

            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div id="adminOnly_name">
                <label class="text-sm text-gray-700">Nama mempelai (Groom & Bride)</label>
                <input id="setNames" class="w-full rounded-md border px-3 py-2 mt-2" placeholder="Nama A & Nama B" />
              </div>

              <div>
                <label class="text-sm text-gray-700">Tanggal acara</label>
                <input id="setDate" type="datetime-local" class="w-full rounded-md border px-3 py-2 mt-2" />
                <p class="text-xs text-gray-400 mt-1">Operator juga dapat mengubah tanggal.</p>
              </div>

              <div id="adminOnly_bg">
                <label class="text-sm text-gray-700">Upload Foto Background (Admin)</label>
                <input id="bgUpload" type="file" accept="image/*" class="w-full mt-2" />
                <p class="text-xs text-gray-400 mt-1">Foto akan menjadi background pada Home.</p>
              </div>

              <div>
                <label class="text-sm text-gray-700">Upload Musik (MP3)</label>
                <input id="musicUpload" type="file" accept="audio/*" class="w-full mt-2" />
                <p class="text-xs text-gray-400 mt-1">Operator & Admin boleh upload musik.</p>
              </div>

              <div>
                <label class="text-sm text-gray-700">Kontrol Musik</label>
                <div class="mt-2 flex items-center gap-3">
                  <button id="playMusic" class="px-4 py-2 rounded-md btn-accent">Play</button>
                  <button id="pauseMusic" class="px-4 py-2 rounded-md border">Pause</button>
                </div>
                <div class="mt-3">
                  <input id="volumeControl" type="range" min="0" max="1" step="0.01" value="0.5" class="w-full" />
                  <div class="text-xs text-gray-400 mt-1">Atur volume (Operator hanya dapat mengubah musik, volume,
                    tanggal, tema)</div>
                </div>
              </div>

              <div id="adminOnly_photoUrl">
                <label class="text-sm text-gray-700">Foto (URL) ‚Äî alternatif</label>
                <input id="setPhoto" class="w-full rounded-md border px-3 py-2 mt-2" placeholder="https://..." />
              </div>

              <div id="adminOnly_pass">
                <label class="text-sm text-gray-700">Password Admin (ubah)</label>
                <input id="setAdminPass" type="password" class="w-full rounded-md border px-3 py-2 mt-2"
                  placeholder="Kosongkan jika tidak ingin ganti" />
              </div>

              <div>
                <label class="text-sm text-gray-700">Tema Warna</label>
                <select id="themeSelect" class="w-full rounded-md border px-3 py-2 mt-2">
                  <option value="default">Clean White (default)</option>
                  <option value="soft-pink">Soft Pink</option>
                  <option value="gold-cream">Gold & Cream</option>
                  <option value="blue-silver">Blue & Silver</option>
                  <option value="sage-green">Sage Green</option>
                  <option value="custom">Custom (hex)</option>
                </select>
                <div id="customThemeInputs" class="mt-2 hidden">
                  <input id="customPrimary" placeholder="#123456" class="w-full rounded-md border px-3 py-2 mb-2" />
                  <input id="customAccent" placeholder="#abcdef" class="w-full rounded-md border px-3 py-2" />
                </div>
              </div>

            </div>

            <div class="mt-4 flex gap-3">
              <button id="saveSettings" class="px-4 py-2 rounded-md btn-accent">Simpan Pengaturan</button>
              <button id="createBook" class="px-4 py-2 rounded-md border">Buat Client Baru</button>
              <button id="resetClient" class="px-4 py-2 rounded-md border">Reset Data Client</button>
            </div>

            <hr class="my-4" />
            <h4 class="font-semibold">Operator Management</h4>
            <div id="opList" class="mt-3"></div>
          </div>
        </section>

        <!-- ABOUT -->
        <section data-section-id="about" class="section hidden">
          <div class="bg-white p-6 round-md card">
            <h3 class="font-semibold">About</h3>
            <p class="text-sm text-gray-600 mt-2">Modern Guestbook template ‚Äî responsive, offline-first (localStorage).
            </p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Popup fullscreen -->
  <div id="fullPopup" class="fixed inset-0 hidden bg-black text-white flex items-center justify-center z-50">
    <div id="fullPopupInner" class="max-w-4xl w-full p-8 space-y-4 text-center"></div>
  </div>

  <!-- Audio element -->
  <audio id="bgAudio" loop></audio>

  <script>
    /* ===========================
       Data & persistence
       =========================== */
    const STORAGE_KEY = 'wedding_guestbook_modern_v1';
    const DEFAULT_ADMIN_PASS = '1234';
    function uid(prefix = 'id') { return prefix + '-' + Math.random().toString(36).slice(2, 9); }

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        const seed = {
          clients: [
            { id: 'client-default', name: 'Default Event', groom: 'Nama A', bride: 'Nama B', photo: '', date: '', adminPass: DEFAULT_ADMIN_PASS, operators: [], guests: [], messages: [], music: '', bgDataUrl: '', theme: 'default' }
          ],
          activeClient: 'client-default'
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(seed));
        return seed;
      }
      try { return JSON.parse(raw); } catch (e) { return { clients: [], activeClient: null }; }
    }
    function saveData(d) { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

    let DB = loadData();
    let activeClientId = DB.activeClient || (DB.clients[0] && DB.clients[0].id);
    let role = null;
    let operatorName = null;

    /* ===========================
       Elements
       =========================== */
    const splash = document.getElementById('splash');
    const loginModal = document.getElementById('loginModal');
    const btnLoginAdmin = document.getElementById('btnLoginAdmin');
    const openOpName = document.getElementById('openOpName');
    const opNameArea = document.getElementById('opNameArea');
    const loginOptions = document.getElementById('loginOptions');
    const btnCancelOp = document.getElementById('btnCancelOp');
    const btnLoginOp = document.getElementById('btnLoginOp');
    const opNameInput = document.getElementById('opNameInput');
    const adminPassInput = document.getElementById('adminPass');

    const app = document.getElementById('app');
    const navBtns = document.querySelectorAll('.navBtn');
    const sections = document.querySelectorAll('.section');
    const sidebar = document.getElementById('sidebar');
    const btnToggleNav = document.getElementById('btnToggleNav');
    const headerUser = document.getElementById('headerUser');
    const displayRole = document.getElementById('displayRole');
    const operatorNameDisplay = document.getElementById('operatorNameDisplay');

    const bgHero = document.getElementById('bgHero');
    const homeNames = document.getElementById('homeNames');
    const homeSambutan = document.getElementById('homeSambutan');
    const homeTotal = document.getElementById('homeTotal');
    const homePresent = document.getElementById('homePresent');
    const homeMsgs = document.getElementById('homeMsgs');
    const homeLatestMsgs = document.getElementById('homeLatestMsgs');
    const countdownWrap = document.getElementById('countdownWrap');

    const bgUpload = document.getElementById('bgUpload');
    const musicUpload = document.getElementById('musicUpload');
    const volumeControl = document.getElementById('volumeControl');
    const playMusicBtn = document.getElementById('playMusic');
    const pauseMusicBtn = document.getElementById('pauseMusic');
    const audioEl = document.getElementById('bgAudio');

    const setDateEl = document.getElementById('setDate');
    const setNamesEl = document.getElementById('setNames');
    const setPhotoEl = document.getElementById('setPhoto');
    const setAdminPassEl = document.getElementById('setAdminPass');

    const themeSelect = document.getElementById('themeSelect');
    const customThemeInputs = document.getElementById('customThemeInputs');
    const customPrimary = document.getElementById('customPrimary');
    const customAccent = document.getElementById('customAccent');

    /* ===========================
       Login handlers
       =========================== */
    openOpName.addEventListener('click', () => {
      loginOptions.classList.add('hidden');
      opNameArea.classList.remove('hidden');
    });
    btnCancelOp.addEventListener('click', () => {
      opNameArea.classList.add('hidden');
      loginOptions.classList.remove('hidden');
    });
    btnLoginAdmin.addEventListener('click', () => {
      const val = adminPassInput.value.trim();
      const adminPass = DB.clients.find(c => c.id === activeClientId)?.adminPass || DEFAULT_ADMIN_PASS;
      if (val === adminPass) {
        role = 'admin';
        sessionStorage.setItem('role', role);
        operatorName = null;
        sessionStorage.removeItem('operatorName');
        initApp();
        loginModal.style.display = 'none';
      } else alert('Password admin salah');
    });
    btnLoginOp.addEventListener('click', () => {
      const name = opNameInput.value.trim();
      if (!name) return alert('Masukkan nama operator');
      role = 'operator';
      operatorName = name;
      sessionStorage.setItem('role', role);
      sessionStorage.setItem('operatorName', operatorName);
      const client = DB.clients.find(c => c.id === activeClientId);
      if (client && !client.operators.includes(name)) { client.operators.push(name); saveData(DB); }
      initApp();
      loginModal.style.display = 'none';
    });

    /* ===========================
       Init app
       =========================== */
    function initApp() {
      app.classList.remove('hidden');
      headerUser.textContent = role === 'admin' ? 'Admin' : `Operator: ${operatorName || ''}`;
      displayRole.textContent = role === 'admin' ? 'Admin' : 'Operator';
      operatorNameDisplay.textContent = operatorName ? `Operator: ${operatorName}` : '';
      toggleAdminControls();
      renderClientInfo();
      renderHome();
      renderDb();
      renderMessages();
      renderOperators();
      initCharts();
      showSection('home');
      startAutoRefresh();
      applyClientTheme();
      hideSplash();
    }

    /* show/hide admin only controls */
    function toggleAdminControls() {
      const adminEls = document.querySelectorAll('#adminOnly_name, #adminOnly_bg, #adminOnly_pass, #adminOnly_photoUrl');
      adminEls.forEach(el => {
        if (role === 'admin') el.style.display = '';
        else el.style.display = 'none';
      });
      // create/reset buttons
      document.getElementById('createBook').style.display = role === 'admin' ? '' : 'none';
      document.getElementById('resetClient').style.display = role === 'admin' ? '' : 'none';
    }

    /* ===========================
       Render client info & home
       =========================== */
    function renderClientInfo() {
      const client = DB.clients.find(c => c.id === activeClientId);
      if (!client) return;
      document.getElementById('sidebarEventName').textContent = client.name || 'Wedding Guestbook';
      document.getElementById('currentBookName').textContent = client.name || 'Default';
      homeNames.textContent = (client.groom || 'Nama A') + ' & ' + (client.bride || 'Nama B');
      homeSambutan.textContent = 'Terima kasih atas kehadiran ‚Äî silakan check-in atau tinggalkan ucapan.';
      const bg = client.bgDataUrl || client.photo || '';
      if (bg) bgHero.style.backgroundImage = `url('${bg}')`;
      if (client.music) { audioEl.src = client.music; }
      if (client.date) setDateEl.value = client.date;
      const vol = localStorage.getItem('bgAudioVolume');
      if (vol) { volumeControl.value = vol; audioEl.volume = parseFloat(vol); }
      applyClientTheme();
    }

    /* Home render */
    function renderHome() {
      const client = DB.clients.find(c => c.id === activeClientId);
      if (!client) return;
      homeTotal.textContent = client.guests.length || 0;
      homePresent.textContent = client.guests.filter(g => g.status === 'Hadir').length || 0;
      homeMsgs.textContent = client.messages.length || 0;
      homeLatestMsgs.innerHTML = '';
      client.messages.slice().reverse().slice(0, 5).forEach(m => {
        const d = document.createElement('div');
        d.className = 'p-3 bg-white round-md';
        d.innerHTML = `<div class="font-semibold">${escapeHtml(m.name || 'Anonim')}</div><div class="text-sm mt-1">${escapeHtml(m.text)}</div><div class="text-xs text-gray-500 mt-2">${m.time}</div>`;
        homeLatestMsgs.appendChild(d);
      });
      renderCountdown();
    }

    /* ===========================
       Navigation & sidebar toggle
       =========================== */
    navBtns.forEach(btn => btn.addEventListener('click', () => showSection(btn.dataset.section)));
    function showSection(id) {
      sections.forEach(s => s.classList.add('hidden'));
      const el = document.querySelector(`[data-section-id="${id}"]`);
      if (el) el.classList.remove('hidden');
    }
    let navHidden = false;
    btnToggleNav.addEventListener('click', () => {
      navHidden = !navHidden;
      if (navHidden) { sidebar.classList.add('sidebar-hidden'); }
      else { sidebar.classList.remove('sidebar-hidden'); }
    });

    /* ===========================
       Logout
       =========================== */
    document.getElementById('btnLogout').addEventListener('click', () => {
      sessionStorage.removeItem('role'); sessionStorage.removeItem('operatorName');
      role = null; operatorName = null; location.reload();
    });

    /* ===========================
       QR scan (camera)
       =========================== */
    const video = document.getElementById('scanVideo');
    const canvas = document.getElementById('scanCanvas');
    const ctx = canvas.getContext && canvas.getContext('2d');
    let stream = null, scanning = false;
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream; await video.play();
        scanning = true; scanLoop();
      } catch (e) { alert('Gagal akses kamera: ' + e.message); }
    }
    function stopCamera() { scanning = false; if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; } }
    function scanLoop() {
      if (!scanning) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA && ctx) {
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const image = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(image.data, image.width, image.height, { inversionAttempts: 'dontInvert' });
        if (code) {
          document.getElementById('scanStatus').textContent = 'Kode: ' + code.data; handleCheckInById(code.data); scanning = false;
          setTimeout(() => { scanning = true; scanLoop(); }, 1500); return;
        }
      }
      requestAnimationFrame(scanLoop);
    }
    document.getElementById('startScan').addEventListener('click', () => startCamera());
    document.getElementById('stopScan').addEventListener('click', () => { stopCamera(); document.getElementById('scanStatus').textContent = ''; });

    /* ===========================
       Check-in & guest submit
       =========================== */
    function handleCheckInById(id) {
      const client = DB.clients.find(c => c.id === activeClientId);
      const g = client.guests.find(x => x.id === id);
      if (g) {
        g.status = 'Hadir'; g.time = new Date().toLocaleString();
        saveData(DB); renderDb(); renderHome(); renderMessages(); updateCharts();
        alert('Check-in: ' + g.name);
      } else alert('Tamu tidak terdaftar: ' + id);
    }

    document.getElementById('btnGuestSubmit').addEventListener('click', (e) => {
      e.preventDefault();
      const name = document.getElementById('guestNameFill').value.trim();
      const jumlah = parseInt(document.getElementById('guestCountFill').value) || 1;
      const contact = document.getElementById('guestContactFill').value.trim();
      const ucapan = document.getElementById('guestUcapanFill').value.trim();
      if (!name) return alert('Nama wajib');
      const client = DB.clients.find(c => c.id === activeClientId);
      const id = uid('G');
      const guest = { id, name, contact, jumlah, date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), status: 'Hadir', ucapan };
      client.guests.push(guest);
      if (ucapan) client.messages.push({ name, text: ucapan, time: new Date().toLocaleString() });
      saveData(DB); renderDb(); renderHome(); renderMessages(); renderRecentCheckins(); genQR(id, document.getElementById('guestQrPreview'));
    });

    /* ===========================
       QR generate & DB render
       =========================== */
    function genQR(payload, container) {
      container.innerHTML = ''; const c = document.createElement('canvas'); container.appendChild(c);
      QRCode.toCanvas(c, payload, { width: 180 }, err => { if (err) container.textContent = 'Gagal generate QR'; });
    }

    function renderRecentCheckins() {
      const box = document.getElementById('checkinRecent'); box.innerHTML = '';
      const client = DB.clients.find(c => c.id === activeClientId);
      client.guests.slice().reverse().slice(0, 8).forEach(g => {
        const d = document.createElement('div'); d.className = 'p-2 bg-white round-md';
        d.innerHTML = `<div class="font-semibold">${g.name}</div><div class="text-xs text-gray-500">${g.time} ‚Ä¢ ${g.jumlah} orang</div>`;
        box.appendChild(d);
      });
    }

    function renderDb(filter = '') {
      const tbody = document.getElementById('dbTbody'); tbody.innerHTML = '';
      const client = DB.clients.find(c => c.id === activeClientId); if (!client) return;
      client.guests.forEach(g => {
        if (filter && !(g.name.toLowerCase().includes(filter) || g.id.toLowerCase().includes(filter))) return;
        const tr = document.createElement('tr'); tr.innerHTML = `<td class="px-3 py-2">${g.id}</td><td class="px-3 py-2">${g.name}</td><td class="px-3 py-2">${g.contact || '-'}</td><td class="px-3 py-2">${g.jumlah || 1}</td><td class="px-3 py-2">${g.date || '-'}</td><td class="px-3 py-2">${g.time || '-'}</td><td class="px-3 py-2">${g.status || 'Belum'}</td><td class="px-3 py-2">${g.ucapan ? g.ucapan.slice(0, 40) : '-'}</td><td class="px-3 py-2"><button data-id="${g.id}" class="editBtn px-2 py-1 rounded-md border">Edit</button> <button data-id="${g.id}" class="qrBtn px-2 py-1 rounded-md border">QR</button></td>`;
        tbody.appendChild(tr);
      });
    }
    document.getElementById('searchInput').addEventListener('input', e => renderDb(e.target.value.toLowerCase()));

    document.addEventListener('click', e => {
      if (e.target.matches('.qrBtn')) {
        const id = e.target.dataset.id;
        const modal = document.createElement('div'); modal.className = 'fixed inset-0 flex items-center justify-center bg-black/40';
        const card = document.createElement('div'); card.className = 'bg-white p-6 rounded-md';
        const c = document.createElement('canvas'); card.appendChild(c);
        QRCode.toCanvas(c, id, { width: 240 }, () => { });
        const close = document.createElement('button'); close.className = 'mt-3 px-3 py-1 rounded-md border'; close.textContent = 'Tutup';
        close.addEventListener('click', () => document.body.removeChild(modal));
        card.appendChild(close); modal.appendChild(card); document.body.appendChild(modal);
      }
      if (e.target.matches('.editBtn')) {
        const id = e.target.dataset.id; const client = DB.clients.find(c => c.id === activeClientId); const guest = client.guests.find(x => x.id === id);
        const newName = prompt('Nama', guest.name); if (newName !== null) { guest.name = newName; saveData(DB); renderDb(); renderHome(); }
      }
      if (e.target && e.target.dataset && e.target.dataset.op) {
        const op = e.target.dataset.op; const client = DB.clients.find(c => c.id === activeClientId);
        client.operators = client.operators.filter(x => x !== op); saveData(DB); renderOperators();
      }
    });

    /* Export CSV */
    document.getElementById('exportCsvBtn').addEventListener('click', () => {
      const client = DB.clients.find(c => c.id === activeClientId);
      const rows = [['id', 'name', 'contact', 'jumlah', 'date', 'time', 'status', 'ucapan']];
      client.guests.forEach(g => rows.push([g.id, g.name, g.contact, g.jumlah, g.date, g.time, g.status, g.ucapan]));
      const csv = rows.map(r => r.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `guests-${client.id}.csv`; a.click(); URL.revokeObjectURL(url);
    });

    /* ===========================
       Messages render & popup
       =========================== */
    function renderMessages() {
      const list = document.getElementById('msgList'); list.innerHTML = '';
      const client = DB.clients.find(c => c.id === activeClientId);
      client.messages.slice().reverse().forEach(m => {
        const card = document.createElement('div'); card.className = 'p-3 bg-white round-md';
        card.innerHTML = `<div class="font-semibold">${escapeHtml(m.name || 'Anonim')}</div><div class="text-sm text-gray-700 mt-1">${escapeHtml(m.text)}</div><div class="text-xs text-gray-500 mt-2">${m.time}</div>`;
        list.appendChild(card);
      });
    }

    function showPopup(msgs) {
      const full = document.getElementById('fullPopup'); const inner = document.getElementById('fullPopupInner'); inner.innerHTML = '';
      msgs.forEach(m => {
        const el = document.createElement('div'); el.className = 'p-6 bg-white text-black round-md';
        el.innerHTML = `<div class="font-Outfit text-xl">${escapeHtml(m.name)}</div><div class="mt-2 text-lg">${escapeHtml(m.text)}</div>`;
        inner.appendChild(el);
      });
      full.classList.remove('hidden');
    }
    document.getElementById('showPopupBtn').addEventListener('click', () => {
      const client = DB.clients.find(c => c.id === activeClientId); const latest = client.messages.slice(-5);
      if (latest.length === 0) return alert('Belum ada ucapan'); showPopup(latest);
    });
    document.getElementById('hidePopupBtn').addEventListener('click', () => document.getElementById('fullPopup').classList.add('hidden'));
    document.getElementById('fullPopup').addEventListener('click', () => document.getElementById('fullPopup').classList.add('hidden'));

    /* ===========================
       Settings save / operators
       =========================== */
    function renderOperators() { const el = document.getElementById('opList'); el.innerHTML = ''; const client = DB.clients.find(c => c.id === activeClientId); client.operators.forEach(o => { const d = document.createElement('div'); d.className = 'flex items-center justify-between p-2 border rounded-md'; d.innerHTML = `<div>${o}</div><button class="px-2 py-1 rounded-md border" data-op="${o}">Hapus</button>`; el.appendChild(d); }); }

    document.getElementById('saveSettings').addEventListener('click', () => {
      const client = DB.clients.find(c => c.id === activeClientId);
      if (role === 'admin') {
        const names = setNamesEl.value.trim();
        if (names) { const parts = names.split('&').map(s => s.trim()); client.groom = parts[0] || client.groom; client.bride = parts[1] || client.bride; client.name = names; }
        const p = setPhotoEl.value.trim(); if (p) client.photo = p;
        const newPass = setAdminPassEl.value.trim(); if (newPass) client.adminPass = newPass;
      }
      const d = setDateEl.value; if (d) client.date = d;
      if (audioEl && audioEl.src) client.music = audioEl.src;
      const themeVal = themeSelect.value;
      if (themeVal === 'custom') { const p = customPrimary.value.trim(), a = customAccent.value.trim(); if (p && a) client.theme = `${p}|${a}`; }
      else client.theme = themeVal;
      saveData(DB); renderClientInfo(); alert('Pengaturan disimpan'); applyClientTheme();
    });

    /* create client */
    document.getElementById('createBook').addEventListener('click', () => {
      if (role !== 'admin') return alert('Hanya Admin yang dapat membuat client baru');
      const id = uid('client'); const name = prompt('Nama client (mis: Dimas & Rara)') || 'Client ' + id;
      const parts = name.split('&').map(s => s.trim()); const groom = parts[0] || 'Nama A'; const bride = parts[1] || 'Nama B';
      const c = { id, name, groom, bride, photo: '', date: '', adminPass: DEFAULT_ADMIN_PASS, operators: [], guests: [], messages: [], music: '', bgDataUrl: '', theme: 'default' };
      DB.clients.push(c); DB.activeClient = id; activeClientId = id; saveData(DB); renderClientInfo(); renderDb(); renderMessages(); renderOperators(); alert('Client baru dibuat: ' + name);
    });

    /* reset client */
    document.getElementById('resetClient').addEventListener('click', () => {
      if (role !== 'admin') return alert('Hanya Admin yang dapat mereset data');
      if (!confirm('Reset semua data client ini?')) return;
      const client = DB.clients.find(c => c.id === activeClientId); client.guests = []; client.messages = []; saveData(DB); renderDb(); renderMessages(); renderHome(); updateCharts(); alert('Data client direset');
    });

    /* ===========================
       Charts
       =========================== */
    let chartGuests = null, chartMsgs = null;
    function initCharts() {
      try {
        const ctxG = document.getElementById('chartGuests').getContext('2d');
        const ctxM = document.getElementById('chartMsgs').getContext('2d');
        chartGuests = new Chart(ctxG, { type: 'bar', data: { labels: [], datasets: [{ label: 'Hadir per jam', data: [], backgroundColor: 'rgba(124,58,237,0.7)' }] }, options: { responsive: true } });
        chartMsgs = new Chart(ctxM, { type: 'line', data: { labels: [], datasets: [{ label: 'Ucapan per jam', data: [], fill: false, borderColor: 'rgb(236,72,153)' }] }, options: { responsive: true } });
        updateCharts();
      } catch (e) { }
    }
    function updateCharts() {
      const client = DB.clients.find(c => c.id === activeClientId); if (!client) return;
      const now = new Date(); const labels = []; for (let i = 23; i >= 0; i--) { const d = new Date(now.getTime() - i * 3600 * 1000); labels.push(d.getHours() + ':00'); }
      const guestsPerHour = labels.map(() => 0); const msgsPerHour = labels.map(() => 0);
      client.guests.forEach(g => { if (!g.time) return; const t = new Date(g.time); const diff = Math.floor((now - t) / 3600000); if (diff >= 0 && diff < 24) { const idx = 23 - diff; guestsPerHour[idx] += (g.jumlah || 1); } });
      client.messages.forEach(m => { if (!m.time) return; const t = new Date(m.time); const diff = Math.floor((now - t) / 3600000); if (diff >= 0 && diff < 24) { const idx = 23 - diff; msgsPerHour[idx] += 1; } });
      if (chartGuests) { chartGuests.data.labels = labels; chartGuests.data.datasets[0].data = guestsPerHour; chartGuests.update(); }
      if (chartMsgs) { chartMsgs.data.labels = labels; chartMsgs.data.datasets[0].data = msgsPerHour; chartMsgs.update(); }
    }

    /* ===========================
       Auto refresh
       =========================== */
    let autoRefreshTimer = null;
    function startAutoRefresh() { if (autoRefreshTimer) clearInterval(autoRefreshTimer); autoRefreshTimer = setInterval(() => { DB = loadData(); activeClientId = DB.activeClient || activeClientId; renderClientInfo(); renderHome(); renderDb(); renderMessages(); renderRecentCheckins(); updateCharts(); }, 5000); }

    /* ===========================
       Utilities
       =========================== */
   function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[c]));
}

/* ===========================
   Audio & upload handling
   =========================== */
if(bgUpload) {
          bgUpload.addEventListener('change', (e) => {
            if (role !== 'admin') { alert('Hanya Admin yang dapat mengganti foto'); return; }
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = () => { const dataUrl = reader.result; const client = DB.clients.find(c => c.id === activeClientId); client.bgDataUrl = dataUrl; saveData(DB); bgHero.style.backgroundImage = `url('${dataUrl}')`; alert('Foto latar berhasil diupload'); };
            reader.readAsDataURL(file);
          });
        }
if(musicUpload) {
          musicUpload.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = () => { audioEl.src = reader.result; audioEl.play().catch(() => { }); const client = DB.clients.find(c => c.id === activeClientId); client.music = reader.result; saveData(DB); alert('Musik berhasil diupload'); }; reader.readAsDataURL(file); });
        }
volumeControl.addEventListener('input', (e) => { audioEl.volume = parseFloat(e.target.value); localStorage.setItem('bgAudioVolume', e.target.value); });
        playMusicBtn.addEventListener('click', () => audioEl.play().catch(() => { }));
        pauseMusicBtn.addEventListener('click', () => audioEl.pause());

        /* Restore & splash */
        function hideSplash(){ setTimeout(()=> { splash.classList.add('hidden'); }, 800);
    }
    window.addEventListener('load', () => {
      DB = loadData(); activeClientId = DB.activeClient || activeClientId;
      const savedRole = sessionStorage.getItem('role'); const savedOp = sessionStorage.getItem('operatorName');
      if (savedRole) { role = savedRole; operatorName = savedOp || null; initApp(); loginModal.style.display = 'none'; }
      else {
        // show login
        loginModal.style.display = '';
      }
      renderClientInfo();
      // hide splash after minimal load
      hideSplash();
    });

    /* ===========================
       Countdown
       =========================== */
    let countdownTimer = null;
    function renderCountdown() {
      const client = DB.clients.find(c => c.id === activeClientId); if (!client) return;
      const wrap = countdownWrap; wrap.innerHTML = '';
      if (!client.date) { wrap.innerHTML = '<div class="text-sm text-gray-500">Tanggal acara belum diset.</div>'; return; }
      function update() {
        const now = new Date(); const dest = new Date(client.date);
        let diff = dest.getTime() - now.getTime();
        if (diff <= 0) { wrap.innerHTML = '<div class="text-sm text-gray-500">Acara sudah berlangsung / sudah lewat.</div>'; clearInterval(countdownTimer); return; }
        const days = Math.floor(diff / 86400000); diff -= days * 86400000;
        const hours = Math.floor(diff / 3600000); diff -= hours * 3600000;
        const mins = Math.floor(diff / 60000); diff -= mins * 60000;
        const secs = Math.floor(diff / 1000);
        wrap.innerHTML = `<div class="countdown"><div class="item"><div class="text-sm font-semibold">${days}</div><div class="text-xs text-gray-500">Hari</div></div><div class="item"><div class="text-sm font-semibold">${hours}</div><div class="text-xs text-gray-500">Jam</div></div><div class="item"><div class="text-sm font-semibold">${mins}</div><div class="text-xs text-gray-500">Menit</div></div><div class="item"><div class="text-sm font-semibold">${secs}</div><div class="text-xs text-gray-500">Detik</div></div></div>`;
      }
      update(); if (countdownTimer) clearInterval(countdownTimer); countdownTimer = setInterval(update, 1000);
    }

    /* ===========================
       Theme handling
       =========================== */
    const THEMES = {
      'default': { primary: '#111827', accent: '#7c3aed', bg: '#fbfbfe', overlay: 'rgba(255,255,255,0.35)' },
      'soft-pink': { primary: '#111827', accent: '#ec4899', bg: '#fff7fb', overlay: 'rgba(236,72,153,0.08)' },
      'gold-cream': { primary: '#111827', accent: '#d4af37', bg: '#fffaf0', overlay: 'rgba(212,175,55,0.08)' },
      'blue-silver': { primary: '#111827', accent: '#2563eb', bg: '#f8fbff', overlay: 'rgba(37,99,235,0.06)' },
      'sage-green': { primary: '#111827', accent: '#6b8f66', bg: '#fbfefb', overlay: 'rgba(107,143,102,0.06)' }
    };

    function applyClientTheme() {
      const client = DB.clients.find(c => c.id === activeClientId); if (!client) return;
      const t = client.theme || 'default';
      if (typeof t === 'string' && t.includes('|')) { const [p, a] = t.split('|'); setThemeVars(p, a, `${p}44`); return; }
      const obj = THEMES[t] || THEMES['default']; setThemeVars(obj.primary, obj.accent, obj.overlay);
      if (themeSelect) themeSelect.value = t;
      if (t === 'custom') customThemeInputs.classList.remove('hidden'); else customThemeInputs.classList.add('hidden');
    }

    function setThemeVars(primary, accent, overlay) {
      document.documentElement.style.setProperty('--primary', primary || '#111827');
      document.documentElement.style.setProperty('--accent', accent || '#7c3aed');
      document.documentElement.style.setProperty('--bg-soft', '#fbfbfe');
      document.documentElement.style.setProperty('--overlay', overlay || 'rgba(12,12,18,0.35)');
      document.documentElement.style.setProperty('--accent-color', accent || '#7c3aed');
      document.querySelectorAll('.btn-accent').forEach(b => {
        b.style.background = `linear-gradient(90deg, ${accent}, ${shadeColor(accent, -18)})`;
        b.style.color = '#fff';
      });
    }
    function shadeColor(hex, percent) {
      try {
        const f = hex.slice(1), t = percent < 0 ? 0 : 255, p = percent < 0 ? percent * -1 : percent;
        const R = parseInt(f.substring(0, 2), 16), G = parseInt(f.substring(2, 4), 16), B = parseInt(f.substring(4, 6), 16);
        const newR = Math.round((t - R) * p / 100) + R;
        const newG = Math.round((t - G) * p / 100) + G;
        const newB = Math.round((t - B) * p / 100) + B;
        return `#${(0x1000000 + (newR << 16) + (newG << 8) + newB).toString(16).slice(1)}`;
      } catch (e) { return hex; }
    }

    if (themeSelect) {
      themeSelect.addEventListener('change', (e) => {
        const val = e.target.value; const client = DB.clients.find(c => c.id === activeClientId);
        if (val === 'custom') { customThemeInputs.classList.remove('hidden'); client.theme = 'custom'; saveData(DB); return; }
        customThemeInputs.classList.add('hidden'); client.theme = val; saveData(DB); applyClientTheme();
      });
    }
    if (customPrimary && customAccent) {
      function applyCustom() { const p = customPrimary.value.trim(), a = customAccent.value.trim(); if (!p || !a) return; const client = DB.clients.find(c => c.id === activeClientId); client.theme = `${p}|${a}`; saveData(DB); applyClientTheme(); }
      customPrimary.addEventListener('change', applyCustom); customAccent.addEventListener('change', applyCustom);
    }

    /* ===========================
       Helpers & final render
       =========================== */
    function renderOperators() { const el = document.getElementById('opList'); el.innerHTML = ''; const client = DB.clients.find(c => c.id === activeClientId); client.operators.forEach(o => { const d = document.createElement('div'); d.className = 'flex items-center justify-between p-2 border rounded-md'; d.innerHTML = `<div>${o}</div><button class="px-2 py-1 rounded-md border" data-op="${o}">Hapus</button>`; el.appendChild(d); }); }

    function hideSplashForce() { splash.classList.add('hidden'); }

    /* initial render */
    renderClientInfo();

  </script>
</body>

</html>